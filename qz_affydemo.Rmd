---
title: "Microarray_analysis"
author: "Q.Zhang"
date: "9/27/2017"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)

```

## get data
The data is downloaded via `GEOquery` package, untared and batch-unzipped. SOFT files are downloaded manually into this directory.

```{r get data, eval=FALSE}
library(GEOquery)
library(affy)
library(simpleaffy)
library(dplyr)
library(readr)
setwd("~/b_affy")
getGEOSuppFiles("GSE48060")
untar("GSE48060/GSE48060_RAW.tar", exdir="data")
cels <- list.files("data/", pattern = "[gz]")
sapply(paste("data", cels, sep="/"), gunzip)
# set this path to which cotains the soft file, [gz] is acceptable
gds5074 <- getGEO(filename='GDS5074.soft.gz')
```

## make labels
``` {r make labels}
# basic info: platform, 
Meta(gds5074)
# data
Table(gds5074)
# exact the labels from soft files
eset <- GDS2eSet(gds5074)
pheno_raw <- pData(eset) %>% tbl_df()
# make phenodata object
files <- system("ls data", intern = TRUE)
mapply(function(p,x) grepl(p, x),
                 p = pheno_raw$sample,
                 x = files) 
# problem identified, require careful curation because the naming sequence is not identical
ph <- tibble(sample_name = pheno_raw$sample,
             file_name = files[mapply(function(p,x) grep(p,x),
                          p = pheno_raw$sample,MoreArgs = list(x = files))],
             disease_state = c(rep('AMI', 31), rep("control", 21)),
             recur = NA)

# modify the labels
ph$recur[grepl('without', pheno_raw$description)] <- 'AMI_no'
ph$recur[grepl('control', pheno_raw$description)] <- 'control'        
ph$recur[is.na(ph$recur)] <- 'AMI_yes'
# have a look
ph
write_tsv(ph, 'data/phenodata.txt')
```



## normalize data and clustering with PCA

Here we use PCA for simple clustering, however there is no obvious pattern... Neither is hclust....

```{r rma normalize}
celpath = "data/"
data = ReadAffy(celfile.path=celpath)
data@phenoData@data[,1] <- ph$recur
data.rma = rma(data)
data.matrix = exprs(data.rma)

```

```{r simple clustering}
# PCA
color=c(rep('red', 31), rep('green', 21))
data.PC = prcomp(t(data.matrix),scale.=FALSE)
PCdf <- data.PC$x %>%  as.data.frame() 
pairs(~PC1+PC2+PC3,data=PCdf, 
   main="PCA clustering", col = color)
# hclust
library(dendextend)
distance <- dist(t(data.matrix),method="maximum")
dendo <- hclust(distance) %>% as.dendrogram()
new_label <- ph$sample_name[match(labels(dendo), ph$file_name)]
new_phl <- ph$recur[match(labels(dendo), ph$file_name)]
new_phl <- gsub('control','green', new_phl)
new_phl[!grepl('green', new_phl)] <- 'red'


dendo %>% set('labels', new_label) %>% 
set("labels_col", new_phl) %>% # change color
  set("labels_cex", 1) %>% # Change size
    plot(main = "hierarchical clustering of samples") # plot

```


## quality control steps
```{r qc}



```
## filter genes
```{r genefilter}

```

## compare two groups: control and disease

```{r compare two groups}
library(limma)
data@phenoData@data[ ,2] = c(rep('disease', 31), rep('control', 21))
ph1 <- data@phenoData
colnames(ph1@data)[2]="source"
groups = ph1@data$source
f = factor(groups,levels=c("control","disease"))
design = model.matrix(~ 0 + f)
colnames(design) = c("control","disease")
data.fit = lmFit(data.matrix,design)

contrast.matrix = makeContrasts(disease-control,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)
```


## find DE genes

```{r DE and annotate}
options(digits=2)
tab = topTable(data.fit.eb,coef=1,number=20000,adjust.method="BH")
volcanoplot(data.fit.eb,coef=1,highlight=10)

library(hgu133plus2.db)
library(annotate)
gene.symbols <- getSYMBOL(rownames(tab), "hgu133plus2")
g <- gene.symbols[!is.na(gene.symbols)] %>%  unname
write_csv(data.frame(g), 'DE_genesyms.csv')
```

## find pathway
copy and paste that csv to [reactome pathway browser] (https://reactome.org/PathwayBrowser/) and download the table of result.
